<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Miodowniki</title>
	<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css"> -->
	<link rel="stylesheet" href="./materialize.min.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" >
	<link rel="stylesheet" href="./mainWindow.css">
</head>
<body class="grey lighten-5">
	<header>
		<nav>
			<div class="nav-wrapper amber darken-2">
				<a class="brand-logo center">Miodowniki</a>
				<ul id="nav-mobile" class="left">
			        <li id=randomizationButton><a><i class="material-icons left">live_tv</i>Losuj odcinek</a></li>
			    </ul>
			    <ul id="nav-mobile" class="right">
			        <li id="searchButton"><a><i class="material-icons right">search</i>Szukaj</a></li>
			    </ul>
			</div>
		</nav>
	</header>
	<main class="container">
	
	<input type="text" id="searchInput" class="input-field hide" placeholder="Wpisz tytuł...">

	<div id="randomization" class="center-align hide">
		<div id="randomEpisode" class="hide">
			<p>Wylosowano:</p>
			<p id="randomEpisodeTitle"></p>
			<p><button id="playRandomEpisodeButton" class="waves-effect waves-light btn amber darken-2">Oglądaj</button></p>
		</div>
		<div class="radios">
		    <p>
		      <input name="group1" type="radio" id="inputAll" />
		      <label for="inputAll">Wszystkie</label>
		    </p>
		    <p>
		      <input name="group1" type="radio" id="inputOldAla" />
		      <label for="inputOldAla">Tylko ze starą Alą</label>
		    </p>
	    </div>
	    <button id="drawLotsButton" class="waves-effect waves-light btn amber darken-2">Losuj</button>
	</div>

	</main>
	<footer class="page-footer amber darken-2 valign-wrapper">
		<div class="container center-align">
			Crated by <b>Arkej</b>			
		</div>
	</footer>

	<script>
		const electron = require('electron');
		const {ipcRenderer, shell} = require('electron');
		const path = require('path');

		let loadedEpisodes;		

		//load episodes
		ipcRenderer.on('loadEpisodes', function(e, episodes){
			loadedEpisodes = episodes;

			const main = document.getElementsByTagName('main')[0];

			Object.keys(episodes).forEach(key => {
				const ul = document.createElement('ul');
				ul.className = 'collection with-header';
				const liHeader = document.createElement('li');
				liHeader.className = 'collection-header center-align grey lighten-4 grey-text text-darken-3';
				liHeader.innerHTML = ('<h5>SEZON ' + key.slice(-2) + '</h5>');

				ul.appendChild(liHeader);
				main.appendChild(ul);

				episodes[key].forEach(episode => {
					const li = document.createElement('li');
					li.className = 'collection-item';
					const liText = document.createTextNode(episode.title);
					const playButton = document.createElement('a');
					playButton.className = 'btn-floating waves-effect waves-light amber darken-2';
					playButton.innerHTML = '<i class="material-icons">play_arrow</i>';

					li.appendChild(liText);
					li.appendChild(playButton);
					ul.appendChild(li);

					playButton.addEventListener('click', () => {
						shell.openItem(path.join(__dirname, 'episodes/' + episode.fileName));
					});
				})

			})
		});

		//handle clicking searchButton
		const searchButton = document.getElementById('searchButton');
		const searchInput = document.getElementById('searchInput');

		searchButton.addEventListener('click', () => {
			randomization.classList.add('hide');
			searchInput.classList.toggle('hide');
			randomEpisodeDiv.classList.add('hide');
			drawLotsButton.innerText = 'Losuj';
			inputAll.checked = false;
			inputOldAla.checked = false;
		})

		//handle search change
		searchInput.addEventListener('keyup', (e) => {
			[...document.getElementsByClassName('collection-item')].forEach((item) => {
				( item.textContent.toLowerCase().includes(e.target.value.toLowerCase()) ) ?
				item.classList.remove('hide') :
				item.classList.add('hide')
			})
		});

		//handle clicking randomizationButton
		const randomizationButton = document.getElementById('randomizationButton');
		const randomization = document.getElementById('randomization');

		randomizationButton.addEventListener('click', () => {
			searchInput.classList.add('hide');
			randomization.classList.toggle('hide');
			randomEpisodeDiv.classList.add('hide');
			drawLotsButton.innerText = 'Losuj';
			inputAll.checked = false;
			inputOldAla.checked = false;
		})

		//handle randomization
		const drawLotsButton = document.getElementById('drawLotsButton');
		const inputAll = document.getElementById('inputAll');
		const inputOldAla = document.getElementById('inputOldAla');
		const randomEpisodeDiv = document.getElementById('randomEpisode');
		const randomEpisodeTitle = document.getElementById('randomEpisodeTitle');
		const playRandomEpisodeButton = document.getElementById('playRandomEpisodeButton');

		drawLotsButton.addEventListener('click', () => {
			if (!inputAll.checked && !inputOldAla.checked) return;

			let episodesToDrawLots = [];

			Object.keys(loadedEpisodes).forEach(key => {
				loadedEpisodes[key].forEach(episode => {
					if (inputOldAla.checked && episode.episode >= 93) return;
					episodesToDrawLots.push(episode)
				});
			});

			const randomNumber = Math.floor(Math.random() * episodesToDrawLots.length);
			const randomEpisode = episodesToDrawLots[randomNumber];

			randomEpisodeDiv.classList.remove('hide');
			randomEpisodeTitle.innerHTML = '<b>' + randomEpisode.title + '</b>';
			drawLotsButton.innerText = 'Losuj inny odcinek';

			playRandomEpisodeButton.addEventListener('click', () => {
						shell.openItem(path.join(__dirname, 'episodes/' + randomEpisode.fileName));
					});
		}) 
	</script>
</body>
</html>